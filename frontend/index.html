<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>제작 계산기</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 p-4">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-2xl font-bold mb-4">내 아이템 관리</h1>
        <table id="inventoryTable" class="min-w-full bg-white shadow mb-6">
            <thead>
                <tr>
                    <th class="px-2 py-1">아이템</th>
                    <th class="px-2 py-1">수량</th>
                    <th class="px-2 py-1">변경</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <button id="refreshCraftable" class="bg-blue-600 text-white px-4 py-2 rounded">제작 가능 아이템 보기</button>
        <div id="craftableList" class="mt-4 space-y-2"></div>
    </div>

<script>
const USER_ID = 1;
async function loadInventory() {
    const res = await fetch(`/users/${USER_ID}/inventory`);
    const data = await res.json();
    const tbody = document.querySelector('#inventoryTable tbody');
    tbody.innerHTML = '';
    data.forEach(item => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td class="border px-2 py-1 flex items-center space-x-2">
                ${item.icon_url ? `<img src="${item.icon_url}" class="w-6 h-6"/>` : ''}
                <span>${item.item_name}</span>
            </td>
            <td class="border px-2 py-1"><input type="number" min="0" value="${item.quantity}" class="w-20 border" /></td>
            <td class="border px-2 py-1"><button class="bg-green-600 text-white px-2 py-1 rounded save-btn" data-item="${item.item_id}">저장</button></td>`;
        tbody.appendChild(tr);
    });
}

async function updateQuantity(itemId, quantity) {
    await fetch(`/users/${USER_ID}/inventory/${itemId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ quantity: Number(quantity) })
    });
}

document.addEventListener('click', async (e) => {
    if (e.target.classList.contains('save-btn')) {
        const itemId = e.target.dataset.item;
        const qtyInput = e.target.closest('tr').querySelector('input');
        await updateQuantity(itemId, qtyInput.value);
        loadInventory();
    } else if (e.target.classList.contains('missing-btn')) {
        const recipeId = e.target.dataset.recipe;
        const res = await fetch(`/users/${USER_ID}/missing-materials/${recipeId}`);
        const data = await res.json();
        alert(data.materials.map(m => `${m.name}: ${m.missing_quantity}`).join('\n'));
    }
});

document.getElementById('refreshCraftable').addEventListener('click', async () => {
    const res = await fetch(`/users/${USER_ID}/craftable-items`);
    const data = await res.json();
    const container = document.getElementById('craftableList');
    container.innerHTML = '';
    data.forEach(recipe => {
        const div = document.createElement('div');
        div.className = 'bg-white p-2 shadow flex items-center justify-between';
        div.innerHTML = `
            <div class="flex items-center space-x-2">
                ${recipe.result_item_icon_url ? `<img src="${recipe.result_item_icon_url}" class="w-6 h-6"/>` : ''}
                <span>${recipe.result_item_name} (제작 가능: ${recipe.craftable_quantity})</span>
            </div>
            <button class="bg-gray-700 text-white px-2 py-1 rounded missing-btn" data-recipe="${recipe.recipe_id}">부족 재료</button>`;
        container.appendChild(div);
    });
});

loadInventory();
</script>
</body>
</html>
